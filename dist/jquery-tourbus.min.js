(function(){(function(t){var i,o,e,s,n,r,h;return t.fn.tourbus=function(i){return null==i&&(i={}),i=t.extend(!0,{},t.fn.tourbus.defaults,i),this.each(function(){return new o(this,i)})},t.fn.tourbus.defaults={debug:!1,autoDepart:!1,target:"body",startAt:0,onDepart:function(){return null},onStop:function(){return null},onLegStart:function(){return null},onLegEnd:function(){return null},leg:{scrollTo:null,scrollSpeed:150,scrollContext:100,orientation:"bottom",align:"left",width:"auto",margin:10,top:null,left:null,arrow:"50%"}},o=function(){function o(i,o){this.id=e(),this.$target=t(o.target),this.$el=t(i),this.$el.data({tourbus:this}),this.options=o,this.currentLegIndex=null,this.totalLegs=this.$el.find("li").length,this._setupEvents(),this.options.autoDepart&&this.$el.trigger("depart.tourbus"),this._log("built tourbus with options",this.options)}return o.prototype.depart=function(){return this.running=!0,this.options.onDepart(this),this._log("departing"),this.legs=this._buildLegs(),this.currentLegIndex=this.options.startAt,this.showLeg(this.currentLegIndex)},o.prototype.stop=function(){return this.running?(this.hideAllLegs(),this.currentLegIndex=this.options.startAt,this.options.onStop(this),this.running=!1):void 0},o.prototype.on=function(t,i,o){return this.$target.on(t,i,o)},o.prototype.currentLeg=function(){return null===this.currentLegIndex?null:this.legs[this.currentLegIndex]},o.prototype.showLeg=function(t){var i,o;return null==t&&(t=this.currentLegIndex),i=this.legs[t],o=this.options.onLegStart(i,this),o!==!1?i.show():void 0},o.prototype.hideLeg=function(t){var i,o;return i=this.legs[t],o=this.options.onLegEnd(i,this),o!==!1?i.hide():void 0},o.prototype.hideAllLegs=function(){return t.each(this.legs,t.proxy(this.hideLeg,this))},o.prototype.next=function(){return this.hideAllLegs(),this.currentLegIndex++,this.currentLegIndex>this.totalLegs-1?this.stop():this.showLeg(this.currentLegIndex)},o.prototype.prev=function(){return this.hideAllLegs(),this.currentLegIndex--,0>this.currentLegIndex?this.stop():this.showLeg(this.currentLegIndex)},o.prototype.destroy=function(){return t.each(this.legs,function(){return this.destroy()}),this._teardownEvents()},o.prototype._buildLegs=function(){var o=this;return this.legs&&this.legs.length&&t.each(this.legs,function(t,i){return i.destroy()}),t.map(this.$el.find("li"),function(e,s){var n,r,h;return n=t(e),r=n.data(),h=new i({content:n.html(),target:r.el||"body",tourbus:o,index:s,rawData:r}),h.render(),o.$target.append(h.$el),h.position(),h.hide(),h})},o.prototype._log=function(){var t;if(this.options.debug)return t=Array(arguments),t.unshift("TOURBUS "+this.id+":"),console.log.apply(console,t)},o.prototype._setupEvents=function(){return this.$el.on("depart.tourbus",t.proxy(this.depart,this)),this.$el.on("stop.tourbus",t.proxy(this.stop,this)),this.$el.on("next.tourbus",t.proxy(this.next,this)),this.$el.on("prev.tourbus",t.proxy(this.prev,this))},o.prototype._teardownEvents=function(){return this.$el.off(".tourbus")},o}(),i=function(){function i(i){if(this.tourbus=i.tourbus,this.rawData=i.rawData,this.content=i.content,this.index=i.index,this.options=i,this.$target=t(i.target),0===this.$target.length)throw""+this.$target.selector+" is not an element!";this._setupOptions(),this._configureElement(),this._configureTarget(),this._configureScroll(),this._setupEvents(),this.tourbus._log("leg "+this.index+" made with options",this.options)}return i.prototype.render=function(){var t,i;return t="centered"===this.options.orientation?"":"tourbus-arrow",this.$el.addClass(" "+t+" tourbus-arrow-"+this.options.orientation+" "),i="<div class='tourbus-leg-inner'>\n  "+this.content+"\n</div>",this.$el.css({width:this.options.width}).html(i),this},i.prototype.destroy=function(){return this.$el.remove(),this._teardownEvents()},i.prototype.position=function(){var t,i,o,e;return"centered"!==this.options.orientation&&(o={},i={top:"left",bottom:"left",left:"top",right:"top"},"number"==typeof this.options.arrow&&(this.options.arrow+="px"),o[i[this.options.orientation]]=this.options.arrow,e="#"+this.id+".tourbus-arrow",this.tourbus._log("adding rule for "+this.id,o),s(""+e+":before, "+e+":after",o)),t=this._offsets(),this.tourbus._log("setting offsets on leg",t),this.$el.css(t)},i.prototype.show=function(){return this.$el.css({visibility:"visible",opacity:1,zIndex:9999}),this.scrollIntoView()},i.prototype.hide=function(){return this.tourbus.options.debug?this.$el.css({visibility:"visible",opacity:.4,zIndex:0}):this.$el.css({visibility:"hidden"})},i.prototype.scrollIntoView=function(){var i;if(t.fn.scrollTo&&!isNaN(this.options.scrollSpeed)&&this.options.scrollTo!==!1)return i=n(this.options.scrollTo,this.$el),this.tourbus._log("scrolling to",i,this.scrollSettings),t.scrollTo(i,this.scrollSettings)},i.prototype._setupOptions=function(){var t;return t=this.tourbus.options.leg,this.options.top=n(this.rawData.top,t.top),this.options.left=n(this.rawData.left,t.left),this.options.scrollTo=n(this.rawData.scrollTo,t.scrollTo),this.options.scrollSpeed=n(this.rawData.scrollSpeed,t.scrollSpeed),this.options.scrollContext=n(this.rawData.scrollContext,t.scrollContext),this.options.margin=n(this.rawData.margin,t.margin),this.options.arrow=this.rawData.arrow||t.arrow,this.options.align=this.rawData.align||t.align,this.options.width=this.rawData.width||t.width,this.options.orientation=this.rawData.orientation||t.orientation},i.prototype._configureElement=function(){return this.id="tourbus-leg-id-"+this.tourbus.id+"-"+this.options.index,this.$el=t("<div class='tourbus-leg'></div>"),this.el=this.$el[0],this.$el.attr({id:this.id}),this.$el.css({zIndex:9999})},i.prototype._setupEvents=function(){return this.$el.on("click",".tourbus-next",t.proxy(this.tourbus.next,this.tourbus)),this.$el.on("click",".tourbus-prev",t.proxy(this.tourbus.prev,this.tourbus)),this.$el.on("click",".tourbus-stop",t.proxy(this.tourbus.stop,this.tourbus))},i.prototype._teardownEvents=function(){return this.$el.off("click")},i.prototype._configureTarget=function(){return this.targetOffset=this.$target.offset(),n(this.options.top,!1)&&(this.targetOffset.top=this.options.top),n(this.options.left,!1)&&(this.targetOffset.left=this.options.left),this.targetWidth=this.$target.outerWidth(),this.targetHeight=this.$target.outerHeight()},i.prototype._configureScroll=function(){return this.scrollSettings={offset:-this.options.scrollContext,easing:"linear",axis:"y",duration:this.options.scrollSpeed}},i.prototype._offsets=function(){var i,o,e,s,h,u,l,p;switch(e=this.$el.height(),s=this.$el.width(),h={},this.options.orientation){case"centered":l=t(window).height(),h.top=this.options.top,n(h.top,!1)||(h.top=l/2-e/2),h.left=this.targetWidth/2-s/2;break;case"left":h.top=this.targetOffset.top,h.left=this.targetOffset.left-s-this.options.margin;break;case"right":h.top=this.targetOffset.top,h.left=this.targetOffset.left+this.targetWidth+this.options.margin;break;case"top":h.top=this.targetOffset.top-e-this.options.margin,h.left=this.targetOffset.left;break;case"bottom":h.top=this.targetOffset.top+this.targetHeight+this.options.margin,h.left=this.targetOffset.left}if(p={top:["left","right"],bottom:["left","right"],left:["top","bottom"],right:["top","bottom"]},r(this.options.orientation,p[this.options.align]))switch(this.options.align){case"right":h.left+=this.targetWidth-s;break;case"bottom":h.top+=this.targetHeight-e}else"center"===this.options.align&&(r(this.options.orientation,p.left)?(u=this.targetWidth/2,o=s/2,i="left"):(u=this.targetHeight/2,o=e/2,i="top"),u>o?h[i]+=u-o:h[i]-=o-u);return h},i.prototype._debugHtml=function(){var i;return i=t.extend(!0,{},this.options),delete i.tourbus,delete i.content,delete i.target,"<small>\n  This leg built with:\n  <pre>"+JSON.stringify(i,void 0,2)+"</pre>\n</small>"},i}(),h=0,e=function(){return h++},n=function(t,i){return null===t||t===void 0?i:t},r=function(t,i){return-1!==(i||[]).indexOf(t)},s=function(i){var o;return o=document.head.appendChild(i).sheet,function(i,e){var s;return s=t.map(Object.keys(e),function(t){return""+t+":"+e[t]}).join(";"),o.insertRule(""+i+" { "+s+" }",o.cssRules.length)}}(document.createElement("style"))})(jQuery)}).call(this);